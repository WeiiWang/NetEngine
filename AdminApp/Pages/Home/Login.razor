@page "/login"
@layout NullLayout
@using System.IdentityModel.Tokens.Jwt;


@using Models.Home


<body>
    <div style="width: 100vw;height: 100vh;text-align: center;background-image: url('../../img/bg.svg');">
        <div style="min-width: 360px;display: inline-block;padding-top: calc(50vh - 170px);">
            <h1>管理系统登录</h1>

            <Form Model="@loginData" OnFinish="OnFinish">

                <FormItem>
                    <Input @bind-Value="@context.Name" Placeholder="用户名" />
                </FormItem>

                <FormItem>
                    <InputPassword @bind-Value="@context.PassWord" Placeholder="密码" />
                </FormItem>

                <FormItem>
                    <Button Type="@ButtonType.Primary" HtmlType="submit" Block>
                        登录
                    </Button>
                </FormItem>
            </Form>

        </div>
    </div>


</body>


@code
{


    override protected void OnInitialized()
    {
        var authorization = LocalStorage.GetItem<string>("Authorization");

        if (!string.IsNullOrEmpty(authorization))
        {
            var securityToken = new JwtSecurityToken(authorization);

            var expTimeL = Convert.ToInt64(securityToken.Claims.ToList().Where(t => t.Type == "exp").FirstOrDefault().Value);

            var expTime = TimeZoneInfo.ConvertTimeToUtc((new DateTime(1970, 1, 1)).ToLocalTime()).ToLocalTime().AddSeconds(expTimeL);

            if (expTime > DateTime.Now)
            {
                NavigationManager.NavigateTo("/");
            }
        }
    }


    private dtoLogin loginData = new();

    private async void OnFinish(EditContext editContext)
    {

        using (var httpResponse = await Http.PostAsJsonAsync<dtoLogin>("Authorize/GetToken", loginData))
        {
            var token = httpResponse.Content.ReadAsStringAsync().Result;

            LocalStorage.SetItem<string>("Authorization", token);

            NavigationManager.NavigateTo("/");
        }

    }


}



